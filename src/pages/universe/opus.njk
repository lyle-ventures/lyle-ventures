---
layout: layouts/universe.njk
title: Investment Opus
permalink: /universe/opus/
---

<div id="opus-app" class="min-h-screen">
  <!-- Header Stats Bar -->
  <div class="border-b border-indigo-500/20 bg-gray-900/50">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <h1 class="text-xl font-semibold text-gray-100">The Exponential Age Investment Opus</h1>
          <p class="text-xs text-gray-500 mt-1">Peak: <span id="peak-date">December 1, 2026</span> | Days: <span id="days-to-peak">--</span></p>
        </div>
        <div class="flex flex-wrap gap-4 sm:gap-6">
          <div class="text-center">
            <p class="text-xs uppercase tracking-wider text-gray-500">BTC</p>
            <p id="btc-price" class="text-lg font-semibold text-gray-100">$--</p>
          </div>
          <div class="text-center">
            <p class="text-xs uppercase tracking-wider text-gray-500">Actual σ</p>
            <p id="actual-sigma" class="text-lg font-semibold text-indigo-400">--</p>
          </div>
          <div class="text-center">
            <p class="text-xs uppercase tracking-wider text-gray-500">Expected σ</p>
            <p id="expected-sigma" class="text-lg font-semibold text-gray-400">--</p>
          </div>
          <div class="text-center">
            <p class="text-xs uppercase tracking-wider text-gray-500">Mispricing</p>
            <p id="mispricing" class="text-lg font-semibold text-green-400">--</p>
          </div>
          <div class="text-center">
            <p class="text-xs uppercase tracking-wider text-gray-500">Phase</p>
            <p id="current-phase" class="text-lg font-semibold text-yellow-400">--</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Dashboard Grid -->
  <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Left Column: Projections & Model -->
      <div class="lg:col-span-2 space-y-6">

        <!-- Projection Table -->
        <div class="universe-card rounded-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400">Projection Table</h2>
            <button onclick="OpusApp.refreshCalculations()" class="text-xs text-indigo-400 hover:text-indigo-300">Refresh</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-gray-700">
                  <th class="text-left py-2 text-gray-500 font-medium">Date</th>
                  <th class="text-right py-2 text-gray-500 font-medium">Baseline</th>
                  <th class="text-right py-2 text-gray-500 font-medium">Sine</th>
                  <th class="text-right py-2 text-gray-500 font-medium">Exp σ</th>
                  <th class="text-right py-2 text-gray-500 font-medium">Expected</th>
                  <th class="text-right py-2 text-gray-500 font-medium">+1.0σ</th>
                  <th class="text-right py-2 text-gray-500 font-medium">+1.5σ</th>
                  <th class="text-right py-2 text-gray-500 font-medium">+2.0σ</th>
                </tr>
              </thead>
              <tbody id="projection-table-body">
                <tr><td colspan="8" class="py-4 text-center text-gray-500">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Portfolio Allocation -->
        <div class="universe-card rounded-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400">Portfolio Allocation</h2>
            <button onclick="OpusApp.showUploadModal('holdings')" class="text-xs text-indigo-400 hover:text-indigo-300">Upload Holdings</button>
          </div>
          <div id="portfolio-content">
            <div class="text-center py-8 text-gray-500">
              <p>No holdings data loaded</p>
              <button onclick="OpusApp.showUploadModal('holdings')" class="mt-2 text-indigo-400 hover:text-indigo-300 text-sm">Upload Schwab CSV</button>
            </div>
          </div>
        </div>

        <!-- Exit Strategy Tracker -->
        <div class="universe-card rounded-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400">Exit Strategy Tracker</h2>
            <button onclick="OpusApp.showUploadModal('orders')" class="text-xs text-indigo-400 hover:text-indigo-300">Upload Orders</button>
          </div>
          <div id="exit-tracker-content">
            <div class="space-y-4">
              <!-- IBIT Exits -->
              <div class="p-4 rounded bg-gray-900/50">
                <h3 class="font-semibold text-gray-200 mb-3">IBIT (Bitcoin ETF)</h3>
                <div class="space-y-2 text-sm" id="ibit-exits">
                  <div class="flex justify-between items-center">
                    <span class="text-gray-400">Exit 1 @ +0.8σ</span>
                    <span id="ibit-exit-1-price" class="text-gray-300">$--</span>
                    <span class="text-gray-500">⬜ Pending</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-400">Exit 2 @ +1.0σ</span>
                    <span id="ibit-exit-2-price" class="text-gray-300">$--</span>
                    <span class="text-gray-500">⬜ Pending</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-400">Exit 3 @ +1.3σ</span>
                    <span id="ibit-exit-3-price" class="text-gray-300">$--</span>
                    <span class="text-gray-500">⬜ Pending</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-400">Exit 4 @ +1.5σ</span>
                    <span id="ibit-exit-4-price" class="text-gray-300">$--</span>
                    <span class="text-gray-500">⬜ Pending</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-gray-400">Exit 5 @ +2.0σ</span>
                    <span id="ibit-exit-5-price" class="text-gray-300">$--</span>
                    <span class="text-gray-500">⬜ Pending</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Status & Research -->
      <div class="space-y-6">

        <!-- Current Status Card -->
        <div class="universe-card rounded-lg p-6">
          <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">Current Status</h2>
          <div class="space-y-4">
            <div>
              <p class="text-xs text-gray-500 mb-1">Zone</p>
              <p id="current-zone" class="text-lg font-semibold text-green-400">ACCUMULATE</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1">BTC vs Expected</p>
              <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
                <div id="btc-progress-bar" class="h-full bg-indigo-500 transition-all" style="width: 50%"></div>
              </div>
              <p id="btc-vs-expected" class="text-xs text-gray-400 mt-1">$89,500 / $180,000 expected</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1">Cycle Progress</p>
              <div class="h-2 bg-gray-800 rounded-full overflow-hidden">
                <div id="cycle-progress-bar" class="h-full bg-yellow-500 transition-all" style="width: 75%"></div>
              </div>
              <p id="cycle-progress-text" class="text-xs text-gray-400 mt-1">Day 1,159 of 1,470</p>
            </div>
          </div>
        </div>

        <!-- Risk Signals -->
        <div class="universe-card rounded-lg p-6">
          <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">Risk Signals</h2>
          <div class="space-y-3" id="risk-signals">
            <div class="flex items-center justify-between">
              <span class="text-gray-300">ISM Manufacturing</span>
              <span class="text-green-400">49.2 ✓</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-gray-300">BTC σ Floor (-2.5)</span>
              <span class="text-green-400">OK ✓</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-gray-300">VIX</span>
              <span class="text-green-400">18.5 ✓</span>
            </div>
          </div>
        </div>

        <!-- σ Price Levels -->
        <div class="universe-card rounded-lg p-6">
          <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">σ Price Levels (Today)</h2>
          <div class="space-y-2 text-sm" id="sigma-levels">
            <div class="flex justify-between">
              <span class="text-red-400">-2.0σ</span>
              <span id="sigma-minus-2" class="text-gray-300">$--</span>
            </div>
            <div class="flex justify-between">
              <span class="text-orange-400">-1.0σ</span>
              <span id="sigma-minus-1" class="text-gray-300">$--</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">0σ (Baseline)</span>
              <span id="sigma-0" class="text-gray-300">$--</span>
            </div>
            <div class="flex justify-between">
              <span class="text-green-400">+0.8σ</span>
              <span id="sigma-plus-08" class="text-gray-300">$--</span>
            </div>
            <div class="flex justify-between">
              <span class="text-green-400">+1.0σ</span>
              <span id="sigma-plus-1" class="text-gray-300">$--</span>
            </div>
            <div class="flex justify-between">
              <span class="text-blue-400">+1.3σ</span>
              <span id="sigma-plus-13" class="text-gray-300">$--</span>
            </div>
            <div class="flex justify-between">
              <span class="text-indigo-400">+1.5σ (Peak)</span>
              <span id="sigma-plus-15" class="text-gray-300">$--</span>
            </div>
            <div class="flex justify-between">
              <span class="text-purple-400">+2.0σ</span>
              <span id="sigma-plus-2" class="text-gray-300">$--</span>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="universe-card rounded-lg p-6">
          <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">Data Management</h2>
          <div class="space-y-2">
            <button onclick="OpusApp.showUploadModal('holdings')" class="w-full py-2 px-4 bg-indigo-500/20 hover:bg-indigo-500/30 text-indigo-300 rounded text-sm transition-colors">
              Upload Holdings CSV
            </button>
            <button onclick="OpusApp.showUploadModal('orders')" class="w-full py-2 px-4 bg-indigo-500/20 hover:bg-indigo-500/30 text-indigo-300 rounded text-sm transition-colors">
              Upload Orders CSV
            </button>
            <button onclick="OpusApp.updateBtcPrice()" class="w-full py-2 px-4 bg-gray-700/50 hover:bg-gray-700 text-gray-300 rounded text-sm transition-colors">
              Refresh BTC Price
            </button>
            <button onclick="OpusApp.exportData()" class="w-full py-2 px-4 bg-gray-700/50 hover:bg-gray-700 text-gray-300 rounded text-sm transition-colors">
              Export Data
            </button>
          </div>
        </div>

        <!-- Mantras -->
        <div class="universe-card rounded-lg p-6">
          <h2 class="text-sm font-bold uppercase tracking-widest text-gray-400 mb-4">Mantras</h2>
          <div class="space-y-3 text-sm text-gray-400 italic">
            <p>"BTC is massively mispriced. The snap-back will be violent."</p>
            <p>"Exit by σ, not by price."</p>
            <p>"Early is okay. Late is fatal."</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="upload-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center">
    <div class="bg-gray-900 border border-indigo-500/30 rounded-lg p-6 max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 id="upload-modal-title" class="text-lg font-semibold text-gray-100">Upload File</h3>
        <button onclick="OpusApp.hideUploadModal()" class="text-gray-500 hover:text-gray-300">&times;</button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-2">Select CSV File</label>
          <input type="file" id="upload-file-input" accept=".csv" class="w-full text-gray-300 text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-indigo-500 file:text-white file:cursor-pointer">
        </div>
        <div id="upload-preview" class="hidden">
          <p class="text-sm text-gray-400 mb-2">Preview:</p>
          <div id="upload-preview-content" class="bg-gray-800 rounded p-3 text-xs text-gray-300 max-h-40 overflow-auto font-mono"></div>
        </div>
        <button onclick="OpusApp.processUpload()" class="w-full py-2 px-4 bg-indigo-500 hover:bg-indigo-600 text-white rounded transition-colors">
          Process Upload
        </button>
      </div>
    </div>
  </div>

  <!-- BTC Price Input Modal -->
  <div id="btc-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center">
    <div class="bg-gray-900 border border-indigo-500/30 rounded-lg p-6 max-w-sm w-full mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-100">Update BTC Price</h3>
        <button onclick="OpusApp.hideBtcModal()" class="text-gray-500 hover:text-gray-300">&times;</button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-2">Current BTC Price ($)</label>
          <input type="number" id="btc-price-input" placeholder="89500" class="w-full bg-gray-800 border border-indigo-500/30 rounded px-4 py-2 text-gray-100 focus:outline-none focus:border-indigo-500">
        </div>
        <button onclick="OpusApp.saveBtcPrice()" class="w-full py-2 px-4 bg-indigo-500 hover:bg-indigo-600 text-white rounded transition-colors">
          Update
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Opus JavaScript -->
<script>
// ============================================================================
// SINE MODEL CALCULATOR
// ============================================================================

const SineModel = {
  // Static parameters
  params: {
    genesisDate: new Date('2009-01-03'),
    cycleBottomDate: new Date('2022-11-21'),
    cyclePeakDate: new Date('2026-12-01'),
    logA: -23.3,
    logB: 7.5,
    logStd: 0.095,
    bottomStdDev: -3.0,
    peakStdDev: 1.5
  },

  // Calculate days between two dates
  daysBetween(date1, date2) {
    const oneDay = 24 * 60 * 60 * 1000;
    return Math.round((date2 - date1) / oneDay);
  },

  // Main calculation function
  calculate(calcDate = new Date()) {
    const p = this.params;

    // Date calculations
    const daysSinceGenesis = this.daysBetween(p.genesisDate, calcDate);
    const daysSinceBottom = this.daysBetween(p.cycleBottomDate, calcDate);
    const daysToPeak = this.daysBetween(calcDate, p.cyclePeakDate);
    const daysInCycle = this.daysBetween(p.cycleBottomDate, p.cyclePeakDate);

    // Log baseline (power law)
    const logBaseline = p.logA + p.logB * Math.log10(daysSinceGenesis);
    const baselinePrice = Math.pow(10, logBaseline);

    // Sine calculation: sin(π * days_since_bottom / days_in_cycle - π/2)
    const sineValue = Math.sin(Math.PI * daysSinceBottom / daysInCycle - Math.PI / 2);

    // Expected σ from sine position
    const t = (sineValue + 1) / 2; // Normalize to [0, 1]
    const expectedSigma = p.bottomStdDev + t * (p.peakStdDev - p.bottomStdDev);

    // Expected price
    const expectedPrice = baselinePrice * Math.pow(10, expectedSigma * p.logStd);

    // Calculate σ levels
    const sigmaLevels = {};
    [-2.0, -1.0, 0.0, 0.5, 0.8, 1.0, 1.3, 1.5, 1.8, 2.0].forEach(sigma => {
      sigmaLevels[sigma] = baselinePrice * Math.pow(10, sigma * p.logStd);
    });

    // Determine phase
    let phase, zone;
    if (sineValue < -0.5) { phase = 'Disbelief'; zone = 'ACCUMULATE'; }
    else if (sineValue < 0.0) { phase = 'Hope'; zone = 'ACCUMULATE'; }
    else if (sineValue < 0.5) { phase = 'Optimism'; zone = 'ACCUMULATE'; }
    else if (sineValue < 0.71) { phase = 'Belief'; zone = 'HOLD'; }
    else if (sineValue < 0.87) { phase = 'Thrill'; zone = 'START SELLING'; }
    else if (sineValue < 0.95) { phase = 'Euphoria'; zone = 'SELL'; }
    else { phase = 'Peak Euphoria'; zone = 'AGGRESSIVE SELL'; }

    return {
      calcDate,
      daysSinceGenesis,
      daysSinceBottom,
      daysToPeak,
      daysInCycle,
      logBaseline,
      baselinePrice,
      sineValue,
      expectedSigma,
      expectedPrice,
      sigmaLevels,
      phase,
      zone
    };
  },

  // Calculate actual σ given a price
  actualSigma(price, baselinePrice) {
    const logPrice = Math.log10(price);
    const logBaseline = Math.log10(baselinePrice);
    return (logPrice - logBaseline) / this.params.logStd;
  },

  // Calculate mispricing percentage
  mispricing(actualPrice, expectedPrice) {
    return ((actualPrice - expectedPrice) / expectedPrice) * 100;
  },

  // Generate projection table for date range
  projectionTable(startDate, endDate, intervalMonths = 1) {
    const results = [];
    let current = new Date(startDate);

    while (current <= endDate) {
      results.push(this.calculate(current));
      current = new Date(current.getFullYear(), current.getMonth() + intervalMonths, current.getDate());
    }

    return results;
  }
};

// ============================================================================
// SCHWAB CSV PARSER
// ============================================================================

const SchwabParser = {
  // Ticker to category mappings
  tickerMappings: {
    crypto: ['IBIT', 'GBTC', 'FBTC', 'BITO'],
    coin: ['COIN'],
    sbet: ['SBET'],
    miners: ['IREN', 'CIFR', 'MARA', 'RIOT', 'CLSK', 'HUT', 'BITF'],
    quality_tech: ['GOOGL', 'GOOG', 'META', 'AMZN', 'AAPL', 'MSFT', 'NVDA'],
    converters: ['COPX', 'FCX', 'TSM', 'VRT', 'GRID'],
    cash: ['SWVXX', 'SPAXX']
  },

  // Parse holdings CSV
  parseHoldings(csvText) {
    const lines = csvText.split('\n');

    // Find header row
    let headerIdx = -1;
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].includes('Symbol') || lines[i].includes('Ticker')) {
        headerIdx = i;
        break;
      }
    }

    if (headerIdx === -1) {
      throw new Error('Could not find header row in CSV');
    }

    // Parse headers
    const headers = this.parseCSVLine(lines[headerIdx]);
    const holdings = [];

    // Parse data rows
    for (let i = headerIdx + 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;

      const values = this.parseCSVLine(line);
      if (values.length < headers.length) continue;

      const row = {};
      headers.forEach((h, idx) => {
        row[h.trim()] = values[idx];
      });

      // Extract ticker
      const ticker = (row['Symbol'] || row['Ticker'] || '').trim();
      if (!ticker || ticker === 'Account Total' || ticker === 'Cash') continue;

      holdings.push({
        ticker,
        description: row['Description'] || row['Security Description'] || '',
        quantity: this.parseNumber(row['Quantity'] || row['Shares']),
        price: this.parseCurrency(row['Price'] || row['Last Price']),
        marketValue: this.parseCurrency(row['Market Value'] || row['Current Value']),
        costBasis: this.parseCurrency(row['Cost Basis'] || row['Cost']),
        gainLoss: this.parseCurrency(row['Gain/Loss $'] || row['Gain/Loss']),
        gainLossPct: this.parsePercent(row['Gain/Loss %']),
        category: this.mapCategory(ticker)
      });
    }

    return holdings;
  },

  // Parse orders CSV
  parseOrders(csvText) {
    const lines = csvText.split('\n');

    let headerIdx = -1;
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].includes('Symbol') && (lines[i].includes('Action') || lines[i].includes('Order'))) {
        headerIdx = i;
        break;
      }
    }

    if (headerIdx === -1) {
      throw new Error('Could not find header row in orders CSV');
    }

    const headers = this.parseCSVLine(lines[headerIdx]);
    const orders = [];

    for (let i = headerIdx + 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;

      const values = this.parseCSVLine(line);
      if (values.length < headers.length) continue;

      const row = {};
      headers.forEach((h, idx) => {
        row[h.trim()] = values[idx];
      });

      const ticker = (row['Symbol'] || '').trim();
      if (!ticker) continue;

      orders.push({
        ticker,
        action: (row['Action'] || row['Side'] || '').toLowerCase(),
        orderType: (row['Order Type'] || 'limit').toLowerCase(),
        quantity: this.parseNumber(row['Quantity'] || row['Qty']),
        limitPrice: this.parseCurrency(row['Limit Price'] || row['Limit']),
        stopPrice: this.parseCurrency(row['Stop Price']),
        status: (row['Status'] || 'open').toLowerCase()
      });
    }

    return orders;
  },

  // Parse a single CSV line (handles quoted fields)
  parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];

      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        result.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    result.push(current.trim());

    return result;
  },

  parseNumber(value) {
    if (!value || value === '--') return 0;
    return parseFloat(String(value).replace(/,/g, '')) || 0;
  },

  parseCurrency(value) {
    if (!value || value === '--') return 0;
    return parseFloat(String(value).replace(/[$,]/g, '').replace(/[()]/g, '-')) || 0;
  },

  parsePercent(value) {
    if (!value || value === '--') return 0;
    return parseFloat(String(value).replace(/%/g, '').replace(/[()]/g, '-')) || 0;
  },

  mapCategory(ticker) {
    for (const [category, tickers] of Object.entries(this.tickerMappings)) {
      if (tickers.includes(ticker)) return category;
    }
    return 'other';
  }
};

// ============================================================================
// PORTFOLIO ANALYZER
// ============================================================================

const PortfolioAnalyzer = {
  // Phase targets
  targets: {
    phase_1: {
      crypto: { min: 50, max: 60, priority: 'maintain' },
      quality_tech: { min: 20, max: 25, priority: 'build' },
      converters: { min: 10, max: 15, priority: 'build' },
      cash: { min: 5, max: 10, priority: 'maintain' },
      other: { min: 0, max: 10, priority: 'trim' }
    }
  },

  analyze(holdings, phase = 'phase_1') {
    const totalValue = holdings.reduce((sum, h) => sum + (h.marketValue || 0), 0);
    if (totalValue === 0) return null;

    // Group by category
    const byCategory = {};
    holdings.forEach(h => {
      const cat = h.category || 'other';
      if (!byCategory[cat]) {
        byCategory[cat] = { positions: [], totalValue: 0 };
      }
      byCategory[cat].positions.push(h);
      byCategory[cat].totalValue += h.marketValue || 0;
    });

    // Merge crypto categories
    const cryptoCategories = ['crypto', 'coin', 'sbet', 'miners'];
    let cryptoTotal = 0;
    const cryptoPositions = [];
    cryptoCategories.forEach(cat => {
      if (byCategory[cat]) {
        cryptoTotal += byCategory[cat].totalValue;
        cryptoPositions.push(...byCategory[cat].positions);
        delete byCategory[cat];
      }
    });
    if (cryptoTotal > 0) {
      byCategory.crypto = { positions: cryptoPositions, totalValue: cryptoTotal };
    }

    // Analyze each category
    const targets = this.targets[phase] || this.targets.phase_1;
    const analysis = [];

    Object.keys(targets).forEach(cat => {
      const target = targets[cat];
      const current = byCategory[cat] || { totalValue: 0, positions: [] };
      const currentPct = (current.totalValue / totalValue) * 100;
      const targetMid = (target.min + target.max) / 2;
      const gap = currentPct - targetMid;

      let status = 'on_target';
      if (currentPct < target.min) status = 'underweight';
      else if (currentPct > target.max) status = 'overweight';

      analysis.push({
        category: cat,
        currentValue: current.totalValue,
        currentPct,
        targetMin: target.min,
        targetMax: target.max,
        gap,
        status,
        priority: target.priority,
        positions: current.positions
      });
    });

    return {
      totalValue,
      categories: analysis,
      cryptoPct: analysis.find(a => a.category === 'crypto')?.currentPct || 0,
      techPct: analysis.find(a => a.category === 'quality_tech')?.currentPct || 0,
      convertersPct: analysis.find(a => a.category === 'converters')?.currentPct || 0,
      cashPct: analysis.find(a => a.category === 'cash')?.currentPct || 0
    };
  }
};

// ============================================================================
// MAIN APP
// ============================================================================

const OpusApp = {
  data: {
    btcPrice: 89500,
    holdings: [],
    orders: [],
    lastUpdate: null
  },

  init() {
    // Load saved data
    this.loadData();
    // Run initial calculations
    this.refreshCalculations();
  },

  loadData() {
    const saved = localStorage.getItem('opus_data');
    if (saved) {
      this.data = { ...this.data, ...JSON.parse(saved) };
    }
  },

  saveData() {
    this.data.lastUpdate = new Date().toISOString();
    localStorage.setItem('opus_data', JSON.stringify(this.data));
  },

  refreshCalculations() {
    const calc = SineModel.calculate(new Date());
    const actualSigma = SineModel.actualSigma(this.data.btcPrice, calc.baselinePrice);
    const mispricing = SineModel.mispricing(this.data.btcPrice, calc.expectedPrice);

    // Update header stats
    document.getElementById('days-to-peak').textContent = calc.daysToPeak;
    document.getElementById('btc-price').textContent = '$' + this.data.btcPrice.toLocaleString();
    document.getElementById('actual-sigma').textContent = actualSigma.toFixed(2) + 'σ';
    document.getElementById('expected-sigma').textContent = calc.expectedSigma.toFixed(2) + 'σ';
    document.getElementById('mispricing').textContent = mispricing.toFixed(1) + '%';
    document.getElementById('current-phase').textContent = calc.phase;
    document.getElementById('current-zone').textContent = calc.zone;

    // Update σ levels
    document.getElementById('sigma-minus-2').textContent = '$' + Math.round(calc.sigmaLevels[-2.0]).toLocaleString();
    document.getElementById('sigma-minus-1').textContent = '$' + Math.round(calc.sigmaLevels[-1.0]).toLocaleString();
    document.getElementById('sigma-0').textContent = '$' + Math.round(calc.sigmaLevels[0]).toLocaleString();
    document.getElementById('sigma-plus-08').textContent = '$' + Math.round(calc.sigmaLevels[0.8]).toLocaleString();
    document.getElementById('sigma-plus-1').textContent = '$' + Math.round(calc.sigmaLevels[1.0]).toLocaleString();
    document.getElementById('sigma-plus-13').textContent = '$' + Math.round(calc.sigmaLevels[1.3]).toLocaleString();
    document.getElementById('sigma-plus-15').textContent = '$' + Math.round(calc.sigmaLevels[1.5]).toLocaleString();
    document.getElementById('sigma-plus-2').textContent = '$' + Math.round(calc.sigmaLevels[2.0]).toLocaleString();

    // Update exit tracker prices (based on today's σ levels)
    document.getElementById('ibit-exit-1-price').textContent = '$' + Math.round(calc.sigmaLevels[0.8]).toLocaleString();
    document.getElementById('ibit-exit-2-price').textContent = '$' + Math.round(calc.sigmaLevels[1.0]).toLocaleString();
    document.getElementById('ibit-exit-3-price').textContent = '$' + Math.round(calc.sigmaLevels[1.3]).toLocaleString();
    document.getElementById('ibit-exit-4-price').textContent = '$' + Math.round(calc.sigmaLevels[1.5]).toLocaleString();
    document.getElementById('ibit-exit-5-price').textContent = '$' + Math.round(calc.sigmaLevels[2.0]).toLocaleString();

    // Update progress bars
    const btcPct = Math.min(100, (this.data.btcPrice / calc.expectedPrice) * 100);
    document.getElementById('btc-progress-bar').style.width = btcPct + '%';
    document.getElementById('btc-vs-expected').textContent =
      '$' + this.data.btcPrice.toLocaleString() + ' / $' + Math.round(calc.expectedPrice).toLocaleString() + ' expected';

    const cyclePct = (calc.daysSinceBottom / calc.daysInCycle) * 100;
    document.getElementById('cycle-progress-bar').style.width = cyclePct + '%';
    document.getElementById('cycle-progress-text').textContent =
      'Day ' + calc.daysSinceBottom + ' of ' + calc.daysInCycle;

    // Generate projection table
    this.updateProjectionTable();

    // Update portfolio if we have data
    if (this.data.holdings.length > 0) {
      this.updatePortfolioView();
    }
  },

  updateProjectionTable() {
    const today = new Date();
    const peakDate = new Date('2026-12-01');
    const projections = SineModel.projectionTable(today, peakDate, 1);

    const tbody = document.getElementById('projection-table-body');
    tbody.innerHTML = projections.map((p, idx) => {
      const dateStr = idx === 0 ? 'TODAY' :
        p.calcDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      const isToday = idx === 0;
      const rowClass = isToday ? 'bg-indigo-500/10' : '';

      return `
        <tr class="${rowClass} border-b border-gray-800/50">
          <td class="py-2 text-gray-${isToday ? '100 font-semibold' : '300'}">${dateStr}</td>
          <td class="py-2 text-right text-gray-400">$${Math.round(p.baselinePrice / 1000)}K</td>
          <td class="py-2 text-right text-gray-400">${p.sineValue.toFixed(3)}</td>
          <td class="py-2 text-right text-indigo-400">${p.expectedSigma.toFixed(2)}σ</td>
          <td class="py-2 text-right text-gray-100">$${Math.round(p.expectedPrice / 1000)}K</td>
          <td class="py-2 text-right text-green-400">$${Math.round(p.sigmaLevels[1.0] / 1000)}K</td>
          <td class="py-2 text-right text-blue-400">$${Math.round(p.sigmaLevels[1.5] / 1000)}K</td>
          <td class="py-2 text-right text-purple-400">$${Math.round(p.sigmaLevels[2.0] / 1000)}K</td>
        </tr>
      `;
    }).join('');
  },

  updatePortfolioView() {
    const analysis = PortfolioAnalyzer.analyze(this.data.holdings);
    if (!analysis) return;

    const content = document.getElementById('portfolio-content');
    content.innerHTML = `
      <div class="mb-4">
        <p class="text-2xl font-semibold text-gray-100">$${analysis.totalValue.toLocaleString()}</p>
        <p class="text-xs text-gray-500">Total Portfolio Value</p>
      </div>
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-gray-700">
            <th class="text-left py-2 text-gray-500">Category</th>
            <th class="text-right py-2 text-gray-500">Current</th>
            <th class="text-right py-2 text-gray-500">Target</th>
            <th class="text-right py-2 text-gray-500">Gap</th>
            <th class="text-right py-2 text-gray-500">Status</th>
          </tr>
        </thead>
        <tbody>
          ${analysis.categories.map(cat => {
            const statusColor = cat.status === 'on_target' ? 'green' :
              cat.status === 'underweight' ? 'red' : 'yellow';
            const statusIcon = cat.status === 'on_target' ? '✓' :
              cat.status === 'underweight' ? '↓' : '↑';
            return `
              <tr class="border-b border-gray-800/50">
                <td class="py-2 text-gray-300 capitalize">${cat.category.replace('_', ' ')}</td>
                <td class="py-2 text-right text-gray-100">${cat.currentPct.toFixed(1)}%</td>
                <td class="py-2 text-right text-gray-400">${cat.targetMin}-${cat.targetMax}%</td>
                <td class="py-2 text-right text-${cat.gap > 0 ? 'yellow' : 'red'}-400">${cat.gap > 0 ? '+' : ''}${cat.gap.toFixed(1)}%</td>
                <td class="py-2 text-right text-${statusColor}-400">${statusIcon} ${cat.status.toUpperCase()}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    `;
  },

  // Modal handlers
  currentUploadType: null,

  showUploadModal(type) {
    this.currentUploadType = type;
    document.getElementById('upload-modal-title').textContent =
      type === 'holdings' ? 'Upload Holdings CSV' : 'Upload Orders CSV';
    document.getElementById('upload-modal').classList.remove('hidden');
    document.getElementById('upload-modal').classList.add('flex');
    document.getElementById('upload-preview').classList.add('hidden');
  },

  hideUploadModal() {
    document.getElementById('upload-modal').classList.add('hidden');
    document.getElementById('upload-modal').classList.remove('flex');
    document.getElementById('upload-file-input').value = '';
  },

  async processUpload() {
    const fileInput = document.getElementById('upload-file-input');
    const file = fileInput.files[0];
    if (!file) return alert('Please select a file');

    const text = await file.text();

    try {
      if (this.currentUploadType === 'holdings') {
        this.data.holdings = SchwabParser.parseHoldings(text);
        alert(`Parsed ${this.data.holdings.length} holdings`);
        this.updatePortfolioView();
      } else {
        this.data.orders = SchwabParser.parseOrders(text);
        alert(`Parsed ${this.data.orders.length} orders`);
      }
      this.saveData();
      this.hideUploadModal();
    } catch (e) {
      alert('Error parsing file: ' + e.message);
    }
  },

  updateBtcPrice() {
    document.getElementById('btc-price-input').value = this.data.btcPrice;
    document.getElementById('btc-modal').classList.remove('hidden');
    document.getElementById('btc-modal').classList.add('flex');
  },

  hideBtcModal() {
    document.getElementById('btc-modal').classList.add('hidden');
    document.getElementById('btc-modal').classList.remove('flex');
  },

  saveBtcPrice() {
    const price = parseFloat(document.getElementById('btc-price-input').value);
    if (price > 0) {
      this.data.btcPrice = price;
      this.saveData();
      this.refreshCalculations();
      this.hideBtcModal();
    }
  },

  exportData() {
    const blob = new Blob([JSON.stringify(this.data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'opus_data_' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
  }
};

// Initialize on load
document.addEventListener('DOMContentLoaded', () => OpusApp.init());
</script>
